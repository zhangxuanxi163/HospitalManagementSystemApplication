<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统计报表 - 医院信息管理系统</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; background-color: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 40px; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .nav-links a { color: white; text-decoration: none; padding: 8px 15px; border-radius: 5px; }
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { color: #666; font-size: 14px; margin-bottom: 10px; }
        .stat-card .value { font-size: 32px; font-weight: bold; color: #333; }
        .stat-card.warning { border-left: 4px solid #ffc107; }
        .stat-card.danger { border-left: 4px solid #dc3545; }
        table { width: 100%; background: white; border-collapse: collapse; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #34495e; color: white; }
        .low-stock { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>统计报表</h1>
            <div class="nav-links">
                <a th:href="@{/}">首页</a>
            </div>
        </div>
    </div>
    
    <div class="container" style="margin-top: 20px;">
        <h2 style="margin: 10px 0 10px 0;">可视化</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
            <div style="background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                <h3 style="margin-bottom: 10px;">库存数量 Top 10</h3>
                <canvas id="barTopInventory"></canvas>
                <div id="barTopInventoryFallback" style="margin-top:10px; font-size: 14px; color:#555;"></div>
            </div>
            <div style="background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                <h3 style="margin-bottom: 10px;">低库存占比</h3>
                <canvas id="pieLowStock"></canvas>
                <div id="pieLowStockFallback" style="margin-top:10px; font-size: 14px; color:#555;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js" onerror="(function(){var s=document.createElement('script');s.src='https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js';document.head.appendChild(s);}())"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        // 使用后端准备好的原始数组，避免在前端处理复杂对象序列化
        const labels = /*[[${topLabels}]]*/ [];
        const values = /*[[${topValues}]]*/ [];

        const containerHasData = (values && values.length > 0);
        const emptyNote = !containerHasData;
        if (emptyNote) {
            const holder = document.createElement('div');
            holder.style.cssText = 'max-width:1200px;margin:10px auto;padding:12px 16px;background:#fff3cd;color:#856404;border:1px solid #ffeeba;border-radius:6px;';
            holder.textContent = '暂无库存数据，完成入库后可查看统计图表。';
            document.body.insertBefore(holder, document.body.children[document.body.children.length-1]);
        }

        const ctxBar = document.getElementById('barTopInventory');
        if (ctxBar && typeof Chart !== 'undefined' && containerHasData) {
            new Chart(ctxBar, {
                type: 'bar',
                data: { labels, datasets: [{ label: '数量', data: values, backgroundColor: 'rgba(102,126,234,0.6)' }] },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        } else {
            // Fallback：用简单的列表展示 Top10
            const fb = document.getElementById('barTopInventoryFallback');
            if (fb) {
                if (!containerHasData) {
                    fb.textContent = '暂无库存数据，完成入库后可查看 Top 10。';
                } else {
                    const frag = document.createElement('div');
                    const ul = document.createElement('ul');
                    ul.style.margin = '0';
                    ul.style.paddingLeft = '18px';
                    for (let i = 0; i < labels.length; i++) {
                        const li = document.createElement('li');
                        li.textContent = labels[i] + '：' + values[i];
                        ul.appendChild(li);
                    }
                    frag.appendChild(ul);
                    fb.innerHTML = '';
                    fb.appendChild(frag);
                }
            }
        }

        // 低库存占比
        const lowCount = /*[[${lowCount}]]*/ 0;
        const okCount = /*[[${okCount}]]*/ 0;
        const ctxPie = document.getElementById('pieLowStock');
        if (ctxPie && typeof Chart !== 'undefined') {
            new Chart(ctxPie, {
                type: 'pie',
                data: {
                    labels: ['低库存', '正常'],
                    datasets: [{ data: [lowCount, okCount], backgroundColor: ['#dc3545', '#28a745'] }]
                }
            });
        } else {
            const fb = document.getElementById('pieLowStockFallback');
            if (fb) {
                fb.textContent = '低库存：' + lowCount + '，正常：' + okCount + '（图表脚本未加载，已使用文本展示）';
            }
        }
        /*]]>*/
    </script>
    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <h3>物资种类</h3>
                <div class="value" th:text="${totalMaterials}">0</div>
            </div>
            <div class="stat-card">
                <h3>库存记录</h3>
                <div class="value" th:text="${totalInventory}">0</div>
            </div>
            <div class="stat-card">
                <h3>库存总价值</h3>
                <div class="value">¥<span th:text="${#numbers.formatDecimal(totalValue, 0, 2)}">0.00</span></div>
            </div>
            <div class="stat-card warning" th:if="${lowStockCount > 0}">
                <h3>低库存预警</h3>
                <div class="value" th:text="${lowStockCount}">0</div>
            </div>
        </div>
        
        <div th:if="${lowStockCount > 0}">
            <h2 style="margin: 20px 0 10px 0;">低库存物资</h2>
            <table>
                <thead>
                    <tr>
                        <th>物资名称</th>
                        <th>当前库存</th>
                        <th>最低库存</th>
                        <th>状态</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="inv : ${lowStock}">
                        <td th:text="${materials.?[id == inv.materialId][0]?.materialName ?: '-'}"></td>
                        <td th:text="${inv.quantity}"></td>
                        <td th:text="${inv.minStock}"></td>
                        <td class="low-stock">需要补货</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <h2 style="margin: 30px 0 10px 0;">库存明细</h2>
        <table>
            <thead>
                <tr>
                    <th>物资名称</th>
                    <th>物资编码</th>
                    <th>当前库存</th>
                    <th>单价</th>
                    <th>库存价值</th>
                </tr>
            </thead>
            <tbody>
                <tr th:if="${#lists.isEmpty(inventories)}">
                    <td colspan="5" style="text-align: center; padding: 40px; color: #999;">暂无库存数据</td>
                </tr>
                <tr th:each="inv : ${inventories}">
                    <td th:text="${materials.?[id == inv.materialId][0]?.materialName ?: '-'}"></td>
                    <td th:text="${materials.?[id == inv.materialId][0]?.materialCode ?: '-'}"></td>
                    <td th:text="${inv.quantity}"></td>
                    <td th:text="${materials.?[id == inv.materialId][0]?.price != null ? ('¥' + #numbers.formatDecimal(materials.?[id == inv.materialId][0]?.price, 0, 2)) : '-'}"></td>
                    <td th:text="${materials.?[id == inv.materialId][0]?.price != null ? ('¥' + #numbers.formatDecimal(materials.?[id == inv.materialId][0]?.price.doubleValue() * inv.quantity, 0, 2)) : '-'}"></td>
                </tr>
            </tbody>
        </table>
    </div>
</body>
</html>







